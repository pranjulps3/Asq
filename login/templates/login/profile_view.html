{% extends 'login/semantic.html' %}
{% block body %}
<div class="ui raised segment" style="border-radius: 5px; ">
    {% load static %}
    <div class="ui segment"  style="border-width: 0px; padding: 0px;margin:0px; height: 12em;">
          <div class="ui left floated image" id="profile-picture">
          {% if profile == user %}
            <a class="ui left black corner label" href="/fillup" style="display: none;">
              <i class="write icon"></i>
            </a>
            {% endif %}
          {% if profile.person.display_pic %}
              <img class="ui left floated small avatar image" src="{{ profile.person.display_pic.url }}"/>
          {% else %}
              <img class="ui left floated small avatar image" src={% static 'img/dummy_user.png' %}/>
          {% endif %}
        </div>
        <div class="ui right floated">
        {% if profile.first_name %}
          <h1 style="margin-bottom: 0px; display: inline;">{{profile.first_name}} &nbsp;{{profile.last_name}}</h1>
          <br>
          {% endif %}
          {% if user.person == profile.person %}
            <h1 style="float:right;display: inline;"><a class="ui icon button" href="/fillup" style="background-color:rgba(0,0,0,0);float:right;display: inline;"><i class="big settings icon"></i></a></h1>
        {% else %}
            <a class="profiles" style="float:right;" id="follow-{{ profile.person.id }}" data = "{{ profile.person.id }}" value = "Follow"> {% if profile.person in user.person.follows.all %}<div class='ui purple labeled icon button'><i class='user icon'></i>unfollow</div> {% else %}<div class='ui basic purple labeled icon button'><i class='add user icon'></i>follow</div>{% endif %}</a>
        {% endif %}
          <a href="" class="ui icon button" style="margin-top: 0px; background-color: rgba(0,0,0,0);"><h3><i class="at icon"></i>{{profile.username}}</h3></a>
          <br>
          <a class="ui transparent icon button"><i class="user icon"></i>&nbsp;{{profile.person.followed_by.count}} &nbsp;followers</a>
          <br>
        <a class="ui icon button" href="mailto:{{ profile.email }}" style="background-color: rgba(0,0,0,0); font-stretch: 3px;"><h2><i class="mail icon"></i>{{profile.email}}</h2></a>
        

        </div>
    </div>
    {% if profile.person.about_me %}
     <div class="ui secondary segment">
     <h3>About Me -</h3>
     <blockquote>
       <p> <i class="quote left icon" style="color: grey;"></i>
       {{profile.person.about_me | linebreaks}}     
       <i class="quote right icon" style="color: grey;"></i></p>
       </blockquote>
     </div>
     {% endif %}
     <div>
     <br>
      <div class="ui top attached tabular menu">
        <a class="item active" data-tab="answers">answers</a>
        <a class="item" data-tab="questions">questions</a>
        <a class="item" data-tab="posts">posts</a>
      </div>
      <div class="ui bottom attached tab segment active" data-tab="answers" style="padding-right: 0px;padding-left: 0px; border-right-width: 0px; border-left-width: 0px;: ">
        {% for ans in usera %}
          <div class="ui top attached segment">
            <center>
              <a href="{% url 'view_question' ans.question.id %}"><h3 style="color: black;">{{ans.question.question}}</h3></a><br>
              <p> {{ ans.question.details }} </p>
            </center>
          </div>
          <div class="ui bottom attached segment">
            {% load comments_tags %}
            {% load post_tags %}
            {% get_answer ans user %}
          </div>
        {% endfor %}
            
      </div>
      <div class="ui bottom attached tab segment" data-tab="questions" style="padding-right: 0px;padding-left: 0px; border-right-width: 0px; border-left-width: 0px;">
        {% for quest in userq %}
          {% question_feed quest user %}
        {% endfor %}
      </div>
      <div class="ui bottom attached tab segment" data-tab="posts" style="padding-right: 0px;padding-left: 0px; border-right-width: 0px; border-left-width: 0px;: ">
        {% for post in userp %}
          {% get_post post user %}
        {% endfor %}
      </div>
     </div>
    </div>


<script type="text/javascript">

$('.menu .item')
  .tab()
;



    </script>

  <script type="text/javascript">
    $('.answer').click(function(){
    var element = $(this);
      $.ajax({
               type: "POST",
               url: "{% url 'upvote_answer'%}",
               data: {'answer_id': $(this).attr('data'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
               dataType: "json",
               success: function(response) {
                      if(response.message == "Upvoted")
                      {
                      element.html("<div class='ui small blue button'><i class='chevron up icon'></i>unvote</div><div class='ui small basic blue left pointing label'>"+response.upvotes+"</div>");
                      // document.getElementById(element.attr('data')).style.color = 'red';
                        }
                        else
                        {
                      element.html("<div class='ui small basic blue button'><i class='chevron up icon'></i>vote</div><div class='ui small basic blue left pointing label'>"+response.upvotes+"</div>");
                            // document.getElementById(element.attr('data')).style.color = 'black';
                        }
                },
                error: function(rs, e) {
                       alert(rs.responseText);
                }
          }); 
    })

$('.answer-delete').click(function(){
    var element = $(this);
    var id = $(this).attr('data');
    if(confirm("Are you sure you want to delete this Post?")){
      $.ajax({
               type: "POST",
               url: "{% url 'delete_answer'%}",
               data: {'answer_id': $(this).attr('data'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
               dataType: "json",
               success: function(response) {
                      if(response.message == "Deleted")
                      {
                        $('.myanswer-'+id).slideToggle()
                        window.location = "/";
                        }
                        else if(resonse.message == 'Unauthenticated')
                        {
                            alert('You are not allowed to do this!!');
                        }
                },
                error: function(rs, e) {
                       alert(rs.responseText);
                }
          }); 
    }
    })
  </script>

<script type="text/javascript">
$('.post').click(function(){
    var element = $(this);
      $.ajax({
               type: "POST",
               url: "{% url 'upvote_post'%}",
               data: {'post_id': $(this).attr('data'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
               dataType: "json",
               success: function(response) {
                      if(response.message == "Upvoted")
                      {
                      element.html("<div class='ui small blue button'><i class='chevron up icon'></i>unvote</div><div class='ui small basic blue left pointing label'>"+response.upvotes+"</div>");
                      // document.getElementById(element.attr('data')).style.color = 'red';
                        }
                        else
                        {
                      element.html("<div class='ui small basic blue button'><i class='chevron up icon'></i>vote</div><div class='ui small basic blue left pointing label'>"+response.upvotes+"</div>");
                            // document.getElementById(element.attr('data')).style.color = 'black';
                        }

                },
                error: function(rs, e) {
                       alert(rs.responseText);
                }
          }); 
    })

$('.post-delete').click(function(){
    var element = $(this);
    var id = $(this).attr('data');
    if(confirm("Are you sure you want to delete this Post?")){
      $.ajax({
               type: "POST",
               url: "{% url 'delete_post'%}",
               data: {'post_id': $(this).attr('data'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
               dataType: "json",
               success: function(response) {
                      if(response.message == "Deleted")
                      {
                        $('.mypost-'+id).slideToggle()
                        }
                        else if(resonse.message == 'Unauthenticated')
                        {
                            alert('You are not allowed to do this!!');
                        }
                },
                error: function(rs, e) {
                       alert(rs.responseText);
                }
          }); 
    }
    })

    </script>
  

<script type="text/javascript">

$('.question-delete').click(function(){
    var element = $(this);
    var id = $(this).attr('data');
    if(confirm("Are you sure you want to delete this Question?")){
      $.ajax({
               type: "POST",
               url: "{% url 'delete_question'%}",
               data: {'question_id': $(this).attr('data'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
               dataType: "json",
               success: function(response) {
                      if(response.message == "Deleted")
                      {
                        window.location.replace("/post/");
                        }
                        else if(resonse.message == 'Unauthenticated')
                        {
                            alert('You are not allowed to do this!!');
                        }
                },
                error: function(rs, e) {
                       alert(rs.responseText);
                }
          }); 
    }
    })


    </script>
    <script type="text/javascript">
    $(document).ready(function() {
    // ADD COMMENT //
    $('.ui.reply.form').submit(function(event){
        event.preventDefault();
        var form = $(this);
        var data =  new FormData(form.get(0));
        $.ajax({
            url: $('.ui.reply.form').attr('action'),
            type: "POST",
            data: data,
            cache: false,
            processData: false,
            contentType: false,
            success: function(json) {
                if (json['success'] == 0) {
                  errors = ""
                  for (var err in json['error']){
                    errors += "" + err + ": " + json['error'][err] + "\n"
                  }
                  alert(errors)                      
                }
                else {
                  var oid = json['oid'];
                    var comment_count = document.getElementById('comments-count-'+json['oid']);
                    if (parseInt(comment_count.innerHTML) == 0) {
                        comment_count.innerHTML = parseInt(comment_count.innerHTML) + 1 + " Comment";
                    } else {
                        comment_count.innerHTML = parseInt(comment_count.innerHTML) + 1 + " Comments";
                    }
                    html = "<div id='comment-div-" + json['id'] + "' style='display:none;'>" +json['html'] +"</div>"
                  $('.comments-'+json['oid']).append(html);
                  $('#comment-div-' + json['id']).slideToggle();
                  // console.log('comments-'+json['oid']);
                  // var app = document.getElementById('comments-'+json['oid']);
                  // app.innerHTML=html;
                  $('textarea#id_comment').val(" ");
                  $('textarea#id_comment').placeholder="Comment...";
                    $('#no-comments').hide()
                }

            },
            error: function(response) {
              alert("error")
            }
         });        
    });
    
    // DELETE COMMENT //
    $('.comments-wrapper').on('click', '.comment-delete-btn', function(event) {
        event.preventDefault();
        var id = $(this).attr('data-id');
        if(confirm("Are you sure you want to delete this comment?")){
              $.ajax({
              type: "GET",
              url: $('.comment-delete-form').attr('action'),
              data: {'id': id, 'csrfmiddlewaretoken' : $("#csrf").attr('value')},
              success: function(data){
                    if(data['success'] == 1) {
                          $('#comment-div-' + id).slideToggle();
                          if (data['count'] == 0) {
                                $('#no-comments').show();
                                var comment_count = document.getElementById('comments-count-'+data['oid']);
                                $('#comments-count-'+data['oid']).hide()
                          }
                          else {
                                var comment_count = document.getElementById('comments-count-'+data['oid']);
                                if (parseInt(comment_count.innerHTML) == 2) {
                                    comment_count.innerHTML = parseInt(comment_count.innerHTML) - 1 + " Comment";
                                } else {
                                    comment_count.innerHTML = parseInt(comment_count.innerHTML) - 1 + " Comments";
                                }
                                $('#no-comments').hide()
                                $('#no-comments').hide()
                          }
                    }
                    else {
                          alert("You don't have permission to delete this comment")
                    }
              }
          });
        }
    });

    // COMMENT EDIT //
    $('.comments-wrapper').on('click', '.comment-edit-class', function(event){

        var id = $(this).attr('data-id');
        $('#comment-edit-' + id).slideToggle();
        $('#comment-' + id).slideToggle();
    });

    $('.comments-wrapper').on('submit', '.edit-form', function(event){
    event.preventDefault();
    var form = $(this);
    var data = form.serialize();
    var id = $(this).attr('data-id');
    var comment = document.getElementById('comment-'+id);
    var error = document.getElementById('edit-form-errors');
    $.ajax({
            type: "POST",
            url: form.attr('action'),
            data: data,

            success: function(data){
                json = JSON.parse(data);
                if(json.success == 1) {
                    comment.innerHTML = $('#input-comment-' + id).val();
                    $('#comment-edit-' + id).slideToggle();
                    $('#comment-' + id).slideToggle();
                } else if(json.success == 0){
                     errors = ""
                  for (var err in json.error){
                    errors += "" + json.error[err] + "\n";
                }
                error.innerHTML = errors;
            }
            },
            dataType: 'html'
        });
    });


    // LIKE UNLIKE COMMENT //
    $('.comments-wrapper').on('click', '.like-comment-btn', function() {
        var id = $(this).attr('data-id');
        if($(this).attr('data-like') == 'like') {
          $('#like-btn-' + id).attr('data-like', 'liked');
                        $('#like-btn-' + id).html("<i class='red heart icon'></i>Unike");
                        
            $.ajax({
                type: "GET",
                url: '/comments/like',
                data: {'comment_id': id},
                success: function(data){
                    if(data['success'] == 1) {
                        $('#likes-count-' + id).text(data['likes_count']);
                    } else{
                       $('#like-btn-' + id).attr('data-like', 'like');
                        $('#like-btn-' + id).html("<i class='heart icon'></i>Like");
                        $('#likes-count-' + id).text(data['likes_count']);
                        // alert(data['error']);
                    }
                }
            });
        } else {
           $('#like-btn-' + id).attr('data-like', 'like');
                        $('#like-btn-' + id).html("<i class='heart icon'></i>Like");
                        
            $.ajax({
                type: "GET",
                url: '/comments/unlike',
                data: {'comment_id': id},
                success: function(data){
                    if(data['success'] == 1) {
                       $('#likes-count-' + id).text(data['likes_count']);
                    } else{
                        // alert(data['error']);
                    }
                }
            });
        }
    });

})</script>

<script type="text/javascript">
  $('#profile-picture').hover(function(event){
    $('.ui.left.corner.label').fadeToggle('fast');
  },function(event){
    $('.ui.left.corner.label').fadeToggle('fast');
  }) ;
</script>
{% endblock %}